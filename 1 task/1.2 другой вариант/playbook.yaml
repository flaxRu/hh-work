---
- hosts: localhost
  connection: local
  become: true

  vars:
    namespace: "postgres"
    chart_name: "postgresql"
    chart_version: "10.0.0"
    release_name: "postgres"
    db_name: "mydb"
    db_user: "myuser"
    db_password: "mypassword"
    table_name: "mytable"

  tasks:
    - name: Install PostgreSQL chart
      community.kubernetes.helm:
        kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
        namespace: "{{ namespace }}"
        chart_name: "{{ chart_name }}"
        chart_version: "{{ chart_version }}"
        release_name: "{{ release_name }}"
        state: present
        values:
          postgresqlDatabase: "{{ db_name }}"
          postgresqlUsername: "{{ db_user }}"
          postgresqlPassword: "{{ db_password }}"
        wait: true
        timeout: 300

    - name: Create PostgreSQL table
      community.kubernetes.k8s:
        kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
        namespace: "{{ namespace }}"
        definition:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: create-table
          spec:
            template:
              metadata:
                name: create-table
              spec:
                restartPolicy: OnFailure
                containers:
                  - name: create-table
                    image: postgres:{{ chart_version }}
                    imagePullPolicy: IfNotPresent
                    env:
                      - name: PGPASSWORD
                        value: "{{ db_password }}"
                    command: ["/bin/sh"]
                    args:
                      - -c
                      - |
                        echo "Creating table {{ table_name }}..."
                        psql -U {{ db_user }} -d {{ db_name }} -c "CREATE TABLE {{ table_name }} (id serial PRIMARY KEY, name varchar(50));"



##Для использования этого playbook вам нужно установить Ansible и установить роль kubernetes.core, выполнив команду ansible-galaxy install kubernetes.core.
##
##Затем вы можете запустить playbook командой ansible-playbook postgresql.yaml. Перед запуском убедитесь, что у вас есть доступ к вашему Kubernetes кластеру и переменная окружения KUBECONFIG установлена правильно.